---

  - apt: update_cache=yes

  - name: ensures that the required packages are present
    apt: name={{ item }} state=latest
    with_items:
      - mysql-client
      - python-pip
      - python-dev
      - libmysqlclient-dev
      - git
      - supervisor

  - name: Ensures pyxis-api-django
    git: repo={{ repo }} dest={{ home }}/{{ repo_name }} force=yes

  - name: Ensures the correct host is set for mysql configuration
    replace: dest={{ django_settings }}
             regexp="192\.168\.33\.42"
             replace="{{ item.host }}"
    with_items: "{{ mysql }}"

  - name: Ensures the correct database name is set for mysql configuration
    replace: dest={{ django_settings }}
             regexp="sandbox"
             replace="{{ item.name }}"
    with_items: "{{ mysql }}"

  - name: Ensures the correct database user is set for mysql configuration
    replace: dest={{ django_settings }}
             regexp="dashboard"
             replace="{{ item.user }}"
    with_items: "{{ mysql }}"

  - name: Ensures the correct database password is set for mysql configuration
    replace: dest={{ django_settings }}
             regexp="password"
             replace="{{ item.password }}"
    with_items: "{{ mysql }}"

  - name: Ensures requirements.txt is installed
    shell: "pip install -r requirements.txt"
    register: pip_install_command
    args:
      chdir: "{{ home }}/{{ repo_name }}/"
    failed_when: pip_install_command.rc != 0

  - name: Ensures supervisor configuration is present
    copy: src=pyxis_api.conf dest=/etc/supervisor/conf.d/pyxis_api.conf

  - name: Ensures supervisor is configured
    supervisorctl: name=pyxis_api state=present

  - name: Ensures web application is served
    supervisorctl: name=pyxis_api state=restarted
